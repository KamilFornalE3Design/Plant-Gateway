@* /Shared/Header/Controls/UserProfileMenu.razor *@

@if (_isAuthenticated)
{
    <div class="pg-user-menu" @onclick:stopPropagation="true">
        <button type="button"
                class="pg-user"
                @onclick="Toggle">
            <div class="pg-user-avatar">@_initials</div>
            <span>@_displayName</span>
            <i data-lucide="chevron-down"></i>
        </button>

        @if (_isOpen)
        {
            <div class="pg-user-menu-popup">
                <div class="pg-user-menu-header">
                    <div class="pg-user-name">@_displayName</div>
                    <div class="pg-user-email">@_email</div>
                </div>

                <button type="button"
                        class="pg-user-menu-link"
                        @onclick="GoToSubscriptions">
                    My subscriptions
                </button>

                <button type="button"
                        class="pg-user-menu-link"
                        @onclick="GoToProfile">
                    Edit my profile
                </button>

                <div class="pg-user-menu-footer">
                    <button type="button"
                            class="pg-user-menu-logout"
                            @onclick="Logout">
                        Logout
                    </button>
                </div>
            </div>
        }
    </div>
}

@code {
    [Inject] private ICurrentUserService CurrentUser { get; set; } = default!;
    [Inject] private IUserProfileNavigation ProfileNavigation { get; set; } = default!;
    [Inject] private IAuthService AuthService { get; set; } = default!;

    private bool _isAuthenticated;
    private bool _isOpen;

    private string _displayName = string.Empty;
    private string _email = string.Empty;
    private string _initials = string.Empty;

    protected override void OnInitialized()
    {
        _isAuthenticated = CurrentUser.IsAuthenticated;

        if (_isAuthenticated)
        {
            _displayName = CurrentUser.DisplayName;
            _email = CurrentUser.Email;
            _initials = BuildInitials(_displayName);
        }
    }

    private static string BuildInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1)
            return parts[0].Substring(0, 1).ToUpperInvariant();

        return string.Concat(
            parts[0].Substring(0, 1),
            parts[1].Substring(0, 1)).ToUpperInvariant();
    }

    private void Toggle()
    {
        _isOpen = !_isOpen;
    }

    private async Task GoToSubscriptions()
    {
        _isOpen = false;
        await ProfileNavigation.NavigateToSubscriptionsAsync();
    }

    private async Task GoToProfile()
    {
        _isOpen = false;
        await ProfileNavigation.NavigateToProfileAsync();
    }

    private async Task Logout()
    {
        _isOpen = false;
        await AuthService.LogoutAsync();
    }
}
